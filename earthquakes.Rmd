---
title: "Earthquake analysis"
author: "Clay Ford"
date: "12/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## About the data

The following web page allows the public to download all earthquakes recorded by the US Geological Survey (USGS) in the past 30 days. 

https://earthquake.usgs.gov/earthquakes/feed/v1.0/csv.php
 
In this project you will import, prepare, visualize and summarize data on earthquakes by completing a series of tasks.

The data has 22 variables which are documented on the following web page: https://earthquake.usgs.gov/data/comcat/index.php

Each row in the data represents one earthquake. The data is ordered by earthquake date in descending order, with the most recent earthquake first.

## 1. Read in the data

Earthquakes data for the past 30 days was retrieved on 2021-12-17 and is available as a CSV file from the following URL:

https://github.com/clayford/earthquakes/blob/main/all_month.csv?raw=true

Import the data as a data frame object. Tip: use the `read_csv()` function in the readr package.

```{r}
library(tidyverse)
URL <- "https://github.com/clayford/earthquakes/blob/main/all_month.csv?raw=true"
d <- read_csv(URL)
```

Take a quick glimpse of the data to get familiar with it and/or look at summaries of the columns.

```{r}
View(d)
glimpse(d)
```

```{r}
d %>% 
  select(where(~ is.character(.x) && length(unique(.x)) < 20)) %>% 
  map(table)
```

```{r}
d %>% 
  select(where(is.numeric)) %>% 
  map(summary)
```


## 2. Create a location column

The place column reports distance and direction from a location (sometimes). Here's a sample:

```{r}
set.seed(22)
d %>% 
  sample_n(20) %>% 
  select(place)
```

Sometimes we are only told things like "off the coast of..." or "South Sandwich Islands region".

Create a column that contains just location. For example, a row with place "40 km NE of Severomuysk, Russia" would have a location of "Severomuysk, Russia". And a row with place "South Sandwich Islands region" would have a location of "South Sandwich Islands region".

```{r}
d <- d %>% 
  mutate(location = stringr::str_extract(place, "(?<=of ).+")) %>%
  mutate(location = if_else(is.na(location), place, location))
```



## 3. Investigate location

1. Which location had the most earthquakes? 
2. How many unique, or distinct, locations are in the data?
3. How many earthquakes happened in California?
4. How many locations had just one earthquake? 

```{r}
# top 6 by location
d %>% 
  count(location) %>% 
  arrange(desc(n)) %>% 
  head()
```

```{r}
# distinct locations
d %>% 
  distinct(location) %>% 
  nrow()
```


```{r}
# number of earthquakes by CA
d %>% 
  filter(stringr::str_detect(location, "CA")) %>% 
  nrow()
```

```{r}
# how many locations had one earthquake
d %>% 
  count(location) %>%
  filter(n == 1) %>% 
  nrow()
```


## 4. Calculate elapsed time between earthquakes

The data is ordered in descending order, with most recent earthquake first. Calculate the time that elapsed between earthquakes. For example, the first two rows have the following times:

```
time 
2021-12-17 20:00:54
2021-12-17 19:50:06
```
The elapsed time between the earthquakes was 648.372 seconds. (The raw data has time down to the thousandth of a second!) That's about 10.8 minutes.

Add this elapsed time to the data as seconds. Name the column "elapsed_time". So the first row above would have a new column as follows:

```
time                 elapsed_time
2021-12-17 20:00:54  648.372

```
The last column will have NA since it's the oldest record in our data and we don't have the time of the earthquake before it.

Hint: this can be accomplished with simple subtraction. See the dplyr vignette "Window Functions" and scroll to the section **Lead and Lag**. One of the examples shows exactly what to do, except you want to use `lead` instead of `lag`.

```{r}
d <- d %>% 
  mutate(elapsed_time = time - lead(time))
```


## 5. Investigate the type column

The type column reports the type of seismic event. What are the counts of the various seismic events?

```{r}
d %>% count(type)
```


## 6. Investigate elapsed time between earthquakes

The previous task hopefully revealed that some "earthquakes" are actually not earthquakes at all. Taking this into account, investigate elapsed time between true earthquakes. How is it distributed? Is the mean a good measure of center? What might be a better measure of center?


```{r}
# very skew
d %>% 
  filter(type == "earthquake") %>% 
  ggplot() +
  aes(x = elapsed_time) +
  geom_histogram(binwidth = 100)
```

```{r}
# median
d %>% 
  filter(type == "earthquake") %>% 
  summarize(m = median(elapsed_time, na.rm = TRUE))
```

```{r}
d %>% 
  filter(type == "earthquake") %>% 
  select(elapsed_time) %>%
  pull() %>% 
  as.numeric() %>% 
  summary()
```

## 7. How does magnitude vary between earthquake types?

Magnitude measures the size of an earthquake on the Richter scale. It is a logarithmic scale which is a fancy way of saying it's multiplicative. An earthquake of magnitude 3 is 10 times stronger than an earthquake of magnitude 2. An earthquake of magnitude 4 is 10 times stronger than an earthquake of magnitude 3. And so on. 

How does the distribution of magnitude vary between earthquake types. This could be answered with a visualization.

```{r}
ggplot(d) +
  aes(x = mag) +
  geom_histogram() +
  facet_wrap(~type, scales = "free_y")
  
```


```{r}
# base R seems easier here
tapply(d$mag, d$type, summary)
```

```{r}
d %>% 
  split(.$type) %>% 
  map(~ summary(.$mag))
```


Note: magnitude can sometimes be negative: https://www.usgs.gov/faqs/how-can-earthquake-have-negative-magnitude


## 8. Which location has the highest mean magnitude?

Only consider locations that had at least 3 earthquakes.

```{r}
d %>% 
  group_by(location) %>% 
  summarise(m = mean(mag),
            n = n()) %>%
  filter(n > 2) %>% 
  arrange(m = desc(m))
```



## 9. Investigate the relationship between depth and magnitude

Is depth of an earthquake associated with its magnitude? A visualization might help explore this.

```{r}
# Anything deeper than 300 kilometers appears to have a mag of at least 4.
ggplot(d) +
  aes(x = depth, y = mag) +
  geom_point()
```

# 10. Investigate the depth error

The depthError column reports the uncertainty of the reported depth of an event in kilometers. How is depthError associated with depth? Does depthError increase as depth increases? Are there influential observations that suppress or amplify this relationship?

```{r}
summary(d$depthError)
quantile(d$depthError, probs = seq(0.90,0.99,.01))
```


```{r}
# no, not really it seems with outlying values included
ggplot(d) +
  aes(x = depth, y = depthError) +
  geom_point() +
  geom_smooth()
```


```{r}
# Seems to be a positive association for those events with smaller depthError
# values, especially for depths up to 400 km.
ggplot(d) +
  aes(x = depth, y = depthError) +
  geom_point() +
  geom_smooth() +
  ylim(c(0,30))
```


## 11. Does magError differ between magType?

The magType column reports the method or algorithm used to calculate the preferred magnitude for the event. 

The magError column reports the uncertainty of the reported magnitude of an event. (ie, the estimated standard error of the magnitude.)

Does magError differ between magType? Are there certain methods that have higher error? A visualization may help investigate this. 

```{r}
# ml and md methods seem to have higher errors
ggplot(d) +
  aes(x = magType, y = magError) +
  geom_boxplot()
```


```{r}
ggplot(d) +
  aes(x = magType, y = magError) +
  geom_jitter(width = 0.2, height = 0, alpha = 1/3)
```


```{r}
tapply(d$magError, d$magType, summary)
```

## 12. Do seismic events in some places tend to have larger magError?

Based on the previous task you hopefully have some sense what constitutes "large" magError in this data. Do these large magErrors seem to be related to certain locations?

```{r}
# yes, Hawaii
d %>% 
  filter(magError > 3) %>% 
  select(place) %>% 
  View()
```


## plot earthquakes

```{r}
d$depthC <- as.character(d$depth)
```


```{r}
library(leaflet)
d %>% 
  filter(depth < 30) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude, radius = ~depth, popup = ~depthC)
```

```{r}
d %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude, radius = ~mag)
```

