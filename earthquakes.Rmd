---
title: "PhD Plus Final Project: Earthquake analysis"
author: "Clay Ford"
date: "Spring 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Instructions

Complete all tasks with working R code. Add explanations and comments when requested or as needed. When done, save your work and email your completed Rmd file to Clay Ford: `clayford@virginia.edu`.

We will all work together on this, pausing to work on each task, and then coming together to discuss how to accomplish the task. Think of this session as completing 10 YOUR TURNS.

## About the data

The following web page allows the public to download all earthquakes recorded by the US Geological Survey (USGS) in the past 30 days. 

<https://earthquake.usgs.gov/earthquakes/feed/v1.0/csv.php>

The data has 22 variables which are documented on the following web page: <https://earthquake.usgs.gov/data/comcat/index.php>

Each row in the data represents one earthquake. The data is ordered by earthquake date in descending order, with the most recent earthquake first.


## 1. Read in the data

Earthquakes data for the past 30 days was retrieved on 2021-12-17 and is available as a CSV file from the following URL:

https://github.com/clayford/earthquakes/blob/main/all_month.csv?raw=true

Using the URL above, import the data as a data frame object and name it "d". Tip: use the `read_csv()` function in the readr package. The base R `read.csv` works just fine, but the `read_csv` function automatically formats the dates for us. Also recall that `read_csv()` works with URLs.

```{r}
library(tidyverse)
URL <- "https://github.com/clayford/earthquakes/blob/main/all_month.csv?raw=true"
d <- read_csv(URL)
```



## 2. Take a quick glimpse of the data 

Use at least two functions to learn about the data.

```{r}
str(d)
glimpse(d)
summary(d)
```

```{r}
# map table to character columns with less than 20 distinct levels
d %>% 
  select(where(~ is.character(.x) & length(unique(.x)) < 20)) %>% 
  map(table)
```

```{r}
# map summary to numeric columns
d %>% 
  select(where(is.numeric)) %>% 
  map(summary)
```

## 3. Visualize the distribution of magnitude

The "mag" variable measures the magnitude of an earthquake on the Richter scale. It is a logarithmic scale which is a fancy way of saying it's multiplicative. An earthquake of magnitude 3 is 10 times stronger than an earthquake of magnitude 2. An earthquake of magnitude 4 is 10 times stronger than an earthquake of magnitude 3. And so on. 

Visualize the distribution of "mag". Comment on this distribution.

```{r}
# Distribution is bimodal, with peaks at about 1 and 4.
ggplot(d) +
  aes(x = mag) +
  geom_density()
```



## 4. Visualize the relationship between depth and magnitude

The "depth" variable measures the depth of an earthquake in kilometers. 

How is the depth of an earthquake associated with its magnitude ("mag")? Create a visualization to investigate. Comment on this relationship (one sentence will do.)

```{r}
# Anything deeper than about 300 kilometers appears to have a mag of at least 4.
ggplot(d) +
  aes(x = depth, y = mag) +
  geom_point()
```


## 5. Investigate the various seismic events

The "type" column reports the type of seismic event. Not all seismic events are earthquakes! (Note: we'll still use the word "earthquake" to mean all seismic events for the remainder of this session.)

Please answer the following questions:

- What are the counts of the various seismic events? 

```{r}
d %>% 
  count(type)
```

- What was the maximum magnitude for each seismic event?

```{r}
d %>% 
  group_by(type) %>% 
  summarize(max = max(mag, na.rm = TRUE))
```



## 6. Visualize the distribution of magnitude between earthquake types

How does the distribution of magnitude vary between earthquake types? Hint: `facet_wrap()` would be good to use for this task.  

Note: magnitude can sometimes be negative: https://www.usgs.gov/faqs/how-can-earthquake-have-negative-magnitude

```{r}
# seismic events that were not "earthquake" tend to be about magnitude 2 or
# lower.
# Earthquakes were bimodal, with concentrations around 0-2 and 4-5
ggplot(d) +
  aes(x = mag) +
  geom_histogram() +
  facet_wrap(~type, scales = "free_y")
  
```



# 7. Visualize the relationship between depth and depth error

The "depth" variable measures the depth of an earthquake in kilometers. The "depthError" column reports the uncertainty of the reported depth. Is "depthError" associated with "depth"? 

- Create a plot to investigate and visualize the relationship between "depthError" and "depth". (Hint: we may need to filter the data or zoom in on it.)


```{r}
# outlying values may obscure relationship
ggplot(d) +
  aes(x = depth, y = depthError) +
  geom_point() +
  geom_smooth()
```


```{r}
# filter for depthError < 30;
# Seems to be a positive association for those events with smaller depthError
# values, especially for depths up to 400 km.
ggplot(d) +
  aes(x = depth, y = depthError) +
  geom_point() +
  geom_smooth() +
  ylim(c(0,50))
```

- Which observations had unusually large depth errors? List those observations showing the depth, depthError, place, and mag columns.

```{r}
d %>% 
  filter(depthError > 50) %>% 
  select(depth, depthError, place, mag)
```


## 8. Visualize the relationship between magError and magType

The "magType" column reports the method or algorithm used to calculate the magnitude for the event. 

The "magError" column reports the uncertainty of the reported magnitude of an event. (ie, the estimated standard error of the magnitude.)

Does magError differ between magType? Are there certain methods that have higher error? _Create at least two visualizations to explore this_. Consider a strip chart, or boxplot, or violin plot. Comment on which algorithms appear to have more uncertainty in their measurements.

```{r}
# ml and md methods seem to have higher errors
ggplot(d) +
  aes(x = magType, y = magError) +
  geom_boxplot()
```


```{r}
ggplot(d) +
  aes(x = magType, y = magError) +
  geom_jitter(width = 0.3, height = 0, alpha = 1/3)
```


```{r}
ggplot(d) +
  aes(x = magType, y = magError) +
  geom_violin()
```


## 9. Investigate location of earthquakes

The place column reports distance and direction from a location (sometimes). Here's a random sample. The function `set.seed(21)` ensures we all see the same random sample.

```{r}
set.seed(21)
d %>% 
  sample_n(6) %>% 
  select(place)
```

Sometimes we are only told things like "off the coast of..." or "California-Nevada border region". 

Below we create a new column called "location" that contains _just the location_ of the seismic event. For example, if a row has place "40 km NE of Severomuysk, Russia" we want location to be "Severomuysk, Russia". And if a row has place "South Sandwich Islands region" we want location to be "South Sandwich Islands region". 

The `str_replace()` function from the stringr package finds a text pattern and replaces it with whatever we specify. Below we define a regular expression ".+ of " that means "one or more characters followed by " of ". We find that text pattern, replace it with nothing, and save the result to a new column called "location". Please run this code.

```{r}
d <- d %>% 
  mutate(location = str_replace(place, ".+ of ", "")) 
```

Compare the result with the existing place column.

```{r}
set.seed(21)
d %>% 
  sample_n(6) %>% 
  select(place, location)
```

Now answer the following questions: 

- Which five locations had the most seismic events? 

```{r}
# top 5 by location
d %>% 
  count(location) %>% 
  slice_max(n, n = 5)

d %>% 
  count(location) %>% 
  arrange(desc(n)) %>% 
  head(n = 5)
```

- Which two locations experienced more than 10 seismic events classified as `type == "quarry blast"`. 

```{r}
d %>% 
  filter(type == "quarry blast") %>% 
  count(location) %>% 
  arrange(desc(n)) %>% 
  filter(n > 10)
```



## 10. Do seismic events in some locations tend to have larger magError?

The "magError" column reports the uncertainty of the reported magnitude of an event. (ie, the estimated standard error of the magnitude.) A "magError" greater than 3 is considered large. Using our new "location" column, is there a location that seems to consistently have large "magErrors"? If so, what location is it?

```{r}
d %>% 
  filter(magError > 3) %>% 
  count(location)

# Pahala, Hawaii
```



## 11. Investigate elapsed time between earthquakes

The data is ordered in descending order, with the _most recent earthquake first_. For example, the first two rows have the following times:

```{r}
d %>% 
  select(time) %>% 
  head(n = 2)
```


The elapsed time between the earthquakes was 648.372 seconds. (The raw data has time down to the thousandth of a second!) That's about 10.8 minutes.

The following R code adds a column called "elapsed_time" that records the time that elapsed before the seismic event occurred. We use the dplyr function `lead()` which returns the "next" value in a vector and perform subtraction. So the first row above will have a new column indicating the previous earthquake happened 648 seconds earlier:

```
time                 elapsed_time
2021-12-17 20:00:54  648.372

```

The last row will have NA since it's the oldest record in our data and we don't have the time of the earthquake before it.

```{r}
d <- d %>% 
  mutate(elapsed_time = time - lead(time))
```

Please perform the following tasks and answer the following questions.

- Create a histogram of elapsed time between earthquakes.

```{r}
# very skew
d %>% 
  ggplot() +
  aes(x = elapsed_time) +
  geom_histogram(binwidth = 100)

```

- What is the median elapsed times between earthquakes?

```{r}
median(d$elapsed_time, na.rm = TRUE)
```

- What was the longest elapsed time between earthquakes and where did it happen?

```{r}
d %>% 
  arrange(desc(elapsed_time)) %>% 
  head(n = 1) %>% 
  select(location, elapsed_time)
```

## 12. Investigate elapsed time in specific places

Previously the elapsed time between earthquakes was calculated for earthquakes worldwide. 

- How frequently did seismic events occur in "The Geysers, CA"? Calculate the median elapsed time.

```{r}
d %>% 
  filter(location == "The Geysers, CA") %>% 
  mutate(elapsed_time = time - lead(time)) %>% 
  summarise(med = median(elapsed_time, na.rm = TRUE)) %>% 
  mutate(med = lubridate::time_length(med, unit = "minutes"))
```

- How frequently did seismic events occur in "Pāhala, Hawaii"? Calculate the median elapsed time. Tip: "Pāhala, Hawaii" has a special character in it. When you `filter()`, consider using something like `str_detect(location, "P*hala, Hawaii")`

```{r}
d %>% 
  filter(str_detect(location, "P*hala, Hawaii")) %>% 
  mutate(elapsed_time = time - lead(time)) %>% 
  summarise(med = median(elapsed_time, na.rm = TRUE)) %>% 
  mutate(med = lubridate::time_length(med, unit = "minutes"))

```


## We're finished! Well done! You rock with high magnitude!

## Appendix: Plotting earthquakes on a map

Our data has latitude and longitude coordinates of the observed seismic event. Longitude is the world's x-axis. Latitude is the world's y-axis. Using these coordinates we can plot the location of events on a map.

Below is an example of how we can do that using the leaflet package. If you have never used leaflet you'll need to install it. Run the code below. An interactive map should be created in the RStudio Viewer that you can double-click or scroll to zoom in on locations. You can also click-and-drag to move around. Try it.

```{r}
library(leaflet)
d %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude)
```


It would be nice if we could click on a point and get information about the earthquake. Fortunately we can use the `popup` argument in the `addCircleMarkers` function. It requires a character string. This means we need to add a character string to our data that contains the information we want to display. The code below creates a popup that reports place, magnitude, and depth.

```{r}
d <- d %>% 
  mutate(info = paste0("place = ", place,  "<br>mag = ", mag, "<br>depth = ", depth))
d %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude, 
                   popup = ~info)
```

It might be nice if the color of the markers reflected the intensity of the magnitude. That way we could see at a glance where the bigger earthquakes happened. Below we update the map of earthquakes to include circles that are colored according to magnitude along with a legend. 


```{r}
# create a palette function; OrRd is a palette from the RColorBrewer package; this creates a palette colored according to the mag column in our data

pal <- colorNumeric("OrRd", d$mag)

# use the pal() function in the color argument for addCircleMarkers)
d %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude, 
                   color = ~pal(mag),
                   popup = ~info) %>% 
  addLegend(pal = pal, values = ~mag, 
            position = "bottomleft")

```

The map is very cluttered with events. Our data has over 9000 rows. We can filter the prior to mapping using familiar tidyverse functions. Below we filter for mag > 2 and location containing the string "CA".

```{r}
d %>% 
  filter(mag > 2 & str_detect(location, "CA")) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude, 
                   color = ~pal(mag),
                   popup = ~info) %>% 
  addLegend(pal = pal, values = ~mag, 
            position = "bottomleft")
```


What's nice about leaflet maps is that they can be embedded in R Markdown HTML reports or presentations. Simply knit your Rmd file and your HTML report will contain a fully interactive map.

For more information and examples: http://rstudio.github.io/leaflet/ 

