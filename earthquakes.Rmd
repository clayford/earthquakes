---
title: "PhD Plus Final Project: Earthquake analysis"
author: "Clay Ford"
date: "Spring 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## About the data

The following web page allows the public to download all earthquakes recorded by the US Geological Survey (USGS) in the past 30 days. 

https://earthquake.usgs.gov/earthquakes/feed/v1.0/csv.php
 
In this project you will import, prepare, visualize and summarize data on earthquakes by completing a series of tasks.

The data has 22 variables which are documented on the following web page: https://earthquake.usgs.gov/data/comcat/index.php

Each row in the data represents one earthquake. The data is ordered by earthquake date in descending order, with the most recent earthquake first.

## 1. Read in the data

Earthquakes data for the past 30 days was retrieved on 2021-12-17 and is available as a CSV file from the following URL:

https://github.com/clayford/earthquakes/blob/main/all_month.csv?raw=true

Import the data as a data frame object. Tip: use the `read_csv()` function in the readr package. The base R `read.csv` works just fine, but the `read_csv` function automatically formats the dates for us.

```{r}
library(tidyverse)
URL <- "https://github.com/clayford/earthquakes/blob/main/all_month.csv?raw=true"
d <- read_csv(URL)
```

## 2. Take a quick glimpse of the data to get familiar with it and look at summaries of the columns. Use at least two functions to learn about the data.

```{r}
View(d)
glimpse(d)
```

```{r}
# all chr vars but place
d %>% 
  select(where(~ is.character(.x) && length(unique(.x)) < 20)) %>% 
  map(table)
```

```{r}
d %>% 
  select(where(is.numeric)) %>% 
  map(summary)
```

## 3. Visualize the relationship between depth and magnitude

The "depth" variable measures the depth of an earthquake in kilometers. The "mag" variable measures the magnitude of an earthquake on the Richter scale. It is a logarithmic scale which is a fancy way of saying it's multiplicative. An earthquake of magnitude 3 is 10 times stronger than an earthquake of magnitude 2. An earthquake of magnitude 4 is 10 times stronger than an earthquake of magnitude 3. And so on. 

How is the depth of an earthquake associated with its magnitude? Comment on this relationship (one sentence will do.)

```{r}
# Anything deeper than about 300 kilometers appears to have a mag of at least 4.
ggplot(d) +
  aes(x = depth, y = mag) +
  geom_point()
```


## 4. What are the counts of the various seismic events?

The "type" column reports the type of seismic event. What are the counts of the various seismic events?

```{r}
d %>% count(type)

#   type             n
#   <chr>        <int>
# 1 earthquake    8882
# 2 explosion       58
# 3 ice quake       20
# 4 other event      3
# 5 quarry blast   115
# 6 sonic boom       1
```


## 5. Visualize the distribution of magnitude between earthquake types

How does the distribution of magnitude vary between earthquake types? Hint: histograms are good for visualizing distributions; `facet_wrap()` would be good to use for this task.  

Note: magnitude can sometimes be negative: https://www.usgs.gov/faqs/how-can-earthquake-have-negative-magnitude

```{r}
# seismic events that were not "earthquake" tend to be about magnitude 2 or
# lower.
# Earthquakes were bimodal, with concentrations around 0-2 and 4-5
ggplot(d) +
  aes(x = mag) +
  geom_histogram() +
  facet_wrap(~type, scales = "free_y")
  
```



# 6. Visualize the relationship between depth and depth error

The depthError column reports the uncertainty of the reported depth of an event in kilometers. Is depthError associated with depth? Are there influential depthError observations that suppress or amplify this relationship? Tip: it may help to filter the data for depthError less than 30.

```{r}
summary(d$depthError)
quantile(d$depthError, probs = seq(0.90,0.99,.01))
```


```{r}
# outlying values may obscure relationship
ggplot(d) +
  aes(x = depth, y = depthError) +
  geom_point() +
  geom_smooth()
```


```{r}
# filter for depthError < 30;
# Seems to be a positive association for those events with smaller depthError
# values, especially for depths up to 400 km.
ggplot(d) +
  aes(x = depth, y = depthError) +
  geom_point() +
  geom_smooth() +
  ylim(c(0,30))
```


## 7. Visualize the relationship between magError between magType

The "magType" column reports the method or algorithm used to calculate the magnitude for the event. 

The "magError" column reports the uncertainty of the reported magnitude of an event. (ie, the estimated standard error of the magnitude.)

Does magError differ between magType? Are there certain methods that have higher error? A visualization may help investigate this. 

```{r}
# ml and md methods seem to have higher errors
ggplot(d) +
  aes(x = magType, y = magError) +
  geom_boxplot()
```


```{r}
ggplot(d) +
  aes(x = magType, y = magError) +
  geom_jitter(width = 0.3, height = 0, alpha = 1/3)
```






## 2. Create a location column

The place column reports distance and direction from a location (sometimes). Here's a sample:

```{r}
set.seed(22)
d %>% 
  sample_n(20) %>% 
  select(place)
```

Sometimes we are only told things like "off the coast of..." or "South Sandwich Islands region".

Create a column that contains just location. For example, a row with place "40 km NE of Severomuysk, Russia" would have a location of "Severomuysk, Russia". And a row with place "South Sandwich Islands region" would have a location of "South Sandwich Islands region".


```{r}
# an easy way, perhaps reckless
d <- d %>% 
  mutate(location = stringr::str_replace(place, ".+ of ", "")) 

```


```{r}
# more complicated way, perhaps safer
d <- d %>% 
  mutate(location = stringr::str_extract(place, "(?<=of ).+")) %>%
  mutate(location = if_else(is.na(location), place, location))
```



## 3. Investigate location

1. Which five locations had the most earthquakes? 
2. How many unique, or distinct, locations are in the data?
3. How many earthquakes happened in California?
4. How many locations had just one earthquake? 

```{r}
# top 5 by location
d %>% 
  count(location) %>% 
  slice_max(n, n = 5)

d %>% 
  count(location) %>% 
  arrange(desc(n)) %>% 
  head(n = 5)

#   location               n
#   <chr>              <int>
# 1 Pahala, Hawaii       694
# 2 The Geysers, CA      691
# 3 Cobb, CA             360
# 4 Mina, Nevada         285
# 5 Searles Valley, CA   148

```


```{r}
# distinct locations
d %>% 
  distinct(location) %>% 
  nrow()

# 1309
```



```{r}
# number of earthquakes in CA

d %>% 
  filter(stringr::str_detect(location, "CA")) %>% 
  nrow()
# 3141
```



```{r}
# how many locations reported one earthquake
d %>% 
  count(location) %>%
  filter(n == 1) %>% 
  nrow()
# 657
```


## 4. Calculate elapsed time between earthquakes

The data is ordered in descending order, with most recent earthquake first. Calculate the time that elapsed between earthquakes. For example, the first two rows have the following times:

```
time 
2021-12-17 20:00:54
2021-12-17 19:50:06
```
The elapsed time between the earthquakes was 648.372 seconds. (The raw data has time down to the thousandth of a second!) That's about 10.8 minutes.

Add this elapsed time to the data as seconds. Name the column "elapsed_time". So the first row above would have a new column as follows:

```
time                 elapsed_time
2021-12-17 20:00:54  648.372

```
The last column will have NA since it's the oldest record in our data and we don't have the time of the earthquake before it.

Hint: this can be accomplished with simple subtraction. See the dplyr vignette "Window Functions" and scroll to the section **Lead and Lag**. One of the examples shows exactly what to do, except you want to use `lead` instead of `lag`.

```{r}
d <- d %>% 
  mutate(elapsed_time = time - lead(time))
```



## 6. Investigate elapsed time between earthquakes

The previous task hopefully revealed that some "earthquakes" are actually not earthquakes at all. Taking this into account, investigate elapsed time between type = "earthquakes". 

- How is it distributed?
- Is the mean a good measure of center? What might be a better measure of center? 
- About how often did an earthquake occur in the past 30 days?


```{r}
# very skew
d %>% 
  filter(type == "earthquake") %>% 
  ggplot() +
  aes(x = elapsed_time) +
  geom_histogram(binwidth = 100)
```

```{r}
# median
d %>% 
  filter(type == "earthquake") %>% 
  summarize(m = median(elapsed_time, na.rm = TRUE))
# 194.6 secs
```

```{r}
# about every 3 minutes or so
d %>% 
  filter(type == "earthquake") %>% 
  select(elapsed_time) %>%
  pull() %>% 
  as.numeric() %>% 
  summary()/60  # convert to mins
```


## 8. Which location has the highest mean magnitude?

Considering locations that had at least 3 earthquakes, which location had the highest mean magnitude.

```{r}
# Macquarie Island 
d %>% 
  group_by(location) %>% 
  summarise(m = mean(mag),
            n = n()) %>%
  filter(n > 2) %>% 
  slice_max(m, n = 5)
```




## 12. Do seismic events in some places tend to have larger magError?

Based on the previous task you hopefully have some sense what constitutes "large" magError in this data. Do these large magErrors (say, greater than 3) seem to be related to certain locations?

```{r}
# yes, Hawaii
d %>% 
  filter(magError > 3) %>% 
  select(place) %>% 
  View()
```


## 13. plot earthquakes

Our data has latitude and longitude coordinates of the observed seismic event. Longitude is the world's x-axis. Latitude is the world's y-axis. Using these coordinates we can plot the location of the event on a map.

Below is an example of how we can do that using the leaflet package. If you have never used leaflet you'll need to install it. Run the code below. An interactive map should be created in the RStudio Viewer that you can double-click or scroll to zoom in on locations. You can also click-and-drag to move around. Try it.

```{r}
library(leaflet)
d %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude)
```


It would be nice if we could click on a point and get information about the earthquake. Fortunately we can use the `popup` argument in the `addCircleMarkers` function. It requires a character string. **This means we need to add a character string to our data that contains the information we want to display.** For example, if we wanted to create a label that displayed magError and depthError, we might do something like this:

```
d <- d %>% 
  mutate(info = paste0("magError = ", magError, "; depthError = ", depthError))

```

That would create a column called "info" that we could use with the popup argument, like so: `popup = ~info`

Update the previous code chunk to display a popup that reports magnitude and depth using the sample code above as a guide.

```{r}
d <- d %>% 
  mutate(info = paste0("mag = ", mag, "; depth = ", depth))
d %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude, 
                   popup = ~info)
```

Finally it might be nice if the color of the markers reflected the intensity of the magnitude. That way we could see at a glance where the bigger earthquakes happened. This requires a bit more work in leaflet. Here's an example using toy data.

```{r}
# create fake data centered over VA
set.seed(1)
n <- 50
x <- rnorm(n, mean = -78)
y <- rnorm(n, mean = 37)
z <- sqrt(x ^ 2 + y ^ 2)
df <- data.frame(x, y, z)

# create a palette function; OrRd is a palette from the RColorBrewer package; this creates a palete colored according to the z column in our toy data
pal <- colorNumeric("OrRd", df$z)

# use the pal() function in the color argument for addCircleMarkers: 
# color = ~pal(z)
leaflet(df) %>%
  addTiles() %>%
  addCircleMarkers(~x, ~y, color = ~pal(z)) %>%
  addLegend(pal = pal, values = ~z, position = "bottomleft")
```


Use the example above as a template to update the map of earthquakes to include circles that are colored according to magnitude along with a legend. 


```{r}
pal <- colorNumeric("OrRd", d$mag)
d %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude, 
                   color = ~pal(mag),
                   popup = ~info) %>% 
  addLegend(pal = pal, values = ~mag, 
            position = "bottomleft")

```


What's nice about leaflet maps is that they can be embedded in R Markdown HTML reports or presentations. Simply knit your Rmd file and your HTML report will contain a fully interactive map.



